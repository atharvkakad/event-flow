<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Registration - College Event Management System</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">EventFlow</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="registration.html">Register</a></li>
                    <li class="nav-item"><a class="nav-link" href="admin-login.html">Admin Login</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="header-section">
        <div class="container" data-aos="fade-down">
            <h1 class="display-4 fw-bold mb-3">Register for an Event</h1>
            <p class="lead">Fill out the form below to secure your spot at our exciting college events!</p>
        </div>
    </header>

    <section class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8" data-aos="zoom-in-up">
                <div class="registration-form-container p-5">
                    <h3 class="text-center mb-4">Participant Details</h3>
                    <form id="registrationForm" novalidate>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <input type="text" class="form-control" id="fullName" placeholder="Full Name">
                                <div class="error-message" id="fullNameError"></div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <input type="text" class="form-control" id="studentId" placeholder="Student ID">
                                <div class="error-message" id="studentIdError"></div>
                            </div>
                        </div>
                        <div class="row">
                             <div class="col-md-6 mb-3">
                                 <input type="email" class="form-control" id="email" placeholder="Email Address">
                                 <div class="error-message" id="emailError"></div>
                             </div>
                             <div class="col-md-6 mb-3">
                                 <input type="tel" class="form-control" id="phone" placeholder="Phone Number (10 digits)">
                                 <div class="error-message" id="phoneError"></div>
                             </div>
                        </div>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="department" placeholder="Department (e.g., Computer Science)">
                            <div class="error-message" id="departmentError"></div>
                        </div>
                        <div class="mb-4">
                            <!-- This <select> will now be populated by the script -->
                            <select class="form-select" id="eventChoice">
                                <option selected disabled value="">Choose Event to Register For...</option>
                                <!-- Static options removed, JS will add dynamic ones -->
                            </select>
                            <div class="error-message" id="eventChoiceError"></div>
                        </div>
                        
                        <div id="formSuccessMessage" class="text-center fw-bold mb-3"></div>

                        <button type="submit" class="btn btn-primary w-100">Submit Registration</button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer text-center">
        <div class="container">
            <p>&copy; 2025 College Event Management System. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script> AOS.init({ once: true, duration: 800 }); </script>

    <!-- ======== SCRIPT UPDATED TO FETCH EVENTS ======== -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- Get elements ---
            const form = document.getElementById('registrationForm');
            const fullName = document.getElementById('fullName');
            const studentId = document.getElementById('studentId');
            const email = document.getElementById('email');
            const phone = document.getElementById('phone');
            const department = document.getElementById('department');
            const eventChoice = document.getElementById('eventChoice');
            const successMessage = document.getElementById('formSuccessMessage');
            const submitButton = form.querySelector('button[type="submit"]');

            // -----------------------------------------------------------------
            // NEW: Load events into the dropdown
            // -----------------------------------------------------------------
            async function loadEventsDropdown() {
                try {
                    const response = await fetch('https://event-flow-ekfv.onrender.com/api/events');
                    if (!response.ok) throw new Error('Failed to load events');
                    
                    const events = await response.json();
                    
                    // Clear any old, static options
                    eventChoice.innerHTML = '<option selected disabled value="">Choose Event to Register For...</option>';
                    
                    if (events.length === 0) {
                        eventChoice.innerHTML = '<option selected disabled value="">No events are available for registration.</option>';
                        return;
                    }

                    // Add each event from the server to the dropdown
                    events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.name; // The value to be sent to the server
                        option.textContent = event.name; // The text the user sees
                        eventChoice.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Error loading events dropdown:', error);
                    eventChoice.innerHTML = '<option selected disabled value="">Error loading events.</option>';
                }
            }
            
            // Run this function as soon as the page loads
            loadEventsDropdown();
            // -----------------------------------------------------------------
            // END OF NEW PART
            // -----------------------------------------------------------------


            // --- This is your existing submit/validation logic ---
            form.addEventListener('submit', function (e) {
                e.preventDefault(); 
                clearAllErrors();
                
                if (validateForm()) {
                    submitButton.disabled = true;
                    submitButton.textContent = 'Submitting...';

                    const formData = {
                        fullName: fullName.value.trim(),
                        studentId: studentId.value.trim(),
                        email: email.value.trim(),
                        phone: phone.value.trim(),
                        department: department.value.trim(),
                        eventChoice: eventChoice.value
                    };

                    fetch('https://event-flow-ekfv.onrender.com/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.message) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        successMessage.textContent = 'Registration successful!';
                        successMessage.style.color = 'var(--primary-glow)';
                        successMessage.style.display = 'block';
                        form.reset();
                        // After reset, re-select the default "Choose Event" option
                        eventChoice.selectedIndex = 0; 
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError('eventChoiceError', error.message || 'Error connecting to server.');
                    })
                    .finally(() => {
                        submitButton.disabled = false;
                        submitButton.textContent = 'Submit Registration';
                    });
                } else {
                    console.log('Form is invalid.');
                }
            });

            // --- These helper functions are the same as before ---
            function validateForm() {
                let isValid = true;
                if (fullName.value.trim() === '') { showError('fullNameError', 'Full Name is required.'); isValid = false; }
                if (studentId.value.trim() === '') { showError('studentIdError', 'Student ID is required.'); isValid = false; }
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (email.value.trim() === '') { showError('emailError', 'Email is required.'); isValid = false; } 
                else if (!emailRegex.test(email.value.trim())) { showError('emailError', 'Please enter a valid email address.'); isValid = false; }
                const phoneRegex = /^\d{10}$/;
                if (phone.value.trim() === '') { showError('phoneError', 'Phone Number is required.'); isValid = false; } 
                else if (!phoneRegex.test(phone.value.trim())) { showError('phoneError', 'Please enter a valid 10-digit phone number.'); isValid = false; }
                if (department.value.trim() === '') { showError('departmentError', 'Department is required.'); isValid = false; }
                // This validation now works with the dynamic list
                if (eventChoice.value === '') { 
                    showError('eventChoiceError', 'Please choose an event.'); 
                    isValid = false; 
                }
                return isValid;
            }

            function showError(errorElementId, message) {
                const errorElement = document.getElementById(errorElementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                const inputElement = document.getElementById(errorElementId.replace('Error', ''));
                if (inputElement) { inputElement.classList.add('is-invalid'); }
            }

            function clearAllErrors() {
                const errorMessages = document.querySelectorAll('.error-message');
                errorMessages.forEach(el => { el.textContent = ''; el.style.display = 'none'; });
                const inputs = form.querySelectorAll('.form-control, .form-select');
                inputs.forEach(el => { el.classList.remove('is-invalid'); });
                successMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>

